<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.61">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    span.s1 {font: 12.0px STIXGeneral}
    span.s2 {font: 12.0px 'Apple Color Emoji'}
  </style>
</head>
<body>
<p class="p1">&lt;markdown-text _ngcontent-c16=""&gt;&lt;span&gt;&lt;h1&gt;Access APIs with access and ID tokens&lt;/h1&gt;</p>
<p class="p1">&lt;blockquote&gt;</p>
<p class="p1">&lt;p&gt;<span class="s1">â­‘</span> <span class="Apple-converted-space">Â  </span>Note: Unlike the out of the box security code solution, access and ID tokens require setting up a process on AODocs to whitelist client IDs.<span class="Apple-converted-space">Â  </span>This is not currently possible out of the box.&lt;/p&gt;</p>
<p class="p1">&lt;/blockquote&gt;</p>
<p class="p1">&lt;p&gt;In general, an access token is a piece of data that acts as a permit to operate on resources.<span class="Apple-converted-space">Â  </span>Usually it's just a random-looking string of characters.<span class="Apple-converted-space">Â  </span>A user who has access to resources on a resource server tells the authorization server it's OK for the client app to have the same access.<span class="Apple-converted-space">Â  </span>The client app then gets a permit (token) it can present to the resource server with each request.&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;The main reason to use access or ID tokens (instead of security code) is to provide the client app with secure delegated access to server resources on your behalf.<span class="Apple-converted-space">Â  </span>It allows authorizing a client app to access and manipulate server resources within a specific scope/time, and without exposing the user's credentials to the app.&lt;/p&gt;</p>
<p class="p1">&lt;h2&gt;Generic authentication flow&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;Authentication flows generally follow this pattern:&lt;/p&gt;</p>
<p class="p1">&lt;ul&gt;</p>
<p class="p1">&lt;li&gt;User asks app to access resource server.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;App asks resource server for access.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;If no token is included in the request, resource server redirects app to authorization server to obtain token.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;If identity has not been established yet, authorization server redirects app to identity provider.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;Identity provider asks the user to identify themselves.<span class="Apple-converted-space">Â  </span>Once identified, the app receives an authentication token.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;App takes authentication token to the authorization server and exchanges it for either an access token with scope or an ID token without scope (and optionally a refresh token).&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;App takes authorization token to resource server and presents it as proof that identity has been established and authorization has been received to perform actions on resources.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;The app presents the token as part of each request from then on until the token expires.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;When the token expires, the app goes to the authorization server and, assuming the user has not revoked consent, exchanges the refresh token for a new access token and goes back to the resource server and presents it to continue working on resources.&lt;/li&gt;</p>
<p class="p1">&lt;/ul&gt;</p>
<p class="p1">&lt;h2&gt;AODocs API authentication flow&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;When the client app gets the user to authenticate, Google generates two tokens: an ID token (JWT) without any scope; and an access token with email address visibility scope ( &lt;a href="https://www.googleapis.com/auth/userinfo.email" target="_blank"&gt;https://www.googleapis.com/auth/userinfo.email&lt;/a&gt; ).<span class="Apple-converted-space">Â  </span>After this step, the AODocs authentication flow is similar, but with some key differences.&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;Each request to AODocs APIs must satisfy two requirements: identify the user, and certify that the provided token was generated by Google.<span class="Apple-converted-space">Â  </span>Either of the tokens issued by Google is capable of providing this proof, so the client app can choose which token serves its purposes better.&lt;/p&gt;</p>
<p class="p1">&lt;blockquote&gt;</p>
<p class="p1">&lt;p&gt;<span class="s2">ðŸ’¡</span> <span class="Apple-converted-space">Â  </span>Tip: The ID token is sufficient to perform AODocs-only actions.<span class="Apple-converted-space">Â  </span>Meanwhile, the access token has the same capability, but additionally allows AODocs to impersonate the user to get access to the Drive scopes required to call Drive APIs.&lt;/p&gt;</p>
<p class="p1">&lt;/blockquote&gt;</p>
<p class="p1">&lt;p&gt;The AODocs authentication flow:&lt;/p&gt;</p>
<p class="p1">&lt;ul&gt;</p>
<p class="p1">&lt;li&gt;User asks app to access resource server.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;App asks resource server for access.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;If no token is included in the request, resource server redirects app to authorization server (Google) to obtain token.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;If identity has not been established yet, authorization server redirects app to identity provider (also Google).&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;Identity provider (Google) asks the user to identify themselves.<span class="Apple-converted-space">Â  </span>Once identified, the app receives an authentication token.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;App takes authentication token to the authorization server (Google) and exchanges it for either an &lt;strong&gt;access token&lt;/strong&gt; with userinfo.email scope; or an &lt;strong&gt;ID token&lt;/strong&gt; without scope (and optionally a refresh token).&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;Depending on what the client app needs to do during each and every request, it chooses the appropriate token for that action and presents it to the resource server to prove that identity has been established, until the token expires.&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;When the token expires, the app goes to the authorization server and, assuming the user has not revoked consent, exchanges the refresh token for a new access token and goes back to the resource server and presents it to continue working on resources.&lt;/li&gt;</p>
<p class="p1">&lt;/ul&gt;</p>
<p class="p1">&lt;p&gt;__[ &lt;code&gt;SIMPLE CHART&lt;/code&gt; ]&lt;/p&gt;</p>
<p class="p1">&lt;blockquote&gt;</p>
<p class="p1">&lt;p&gt;<span class="s1">â­‘</span><span class="Apple-converted-space">Â  </span>&lt;strong&gt;Note&lt;/strong&gt;: Normally you need access to the Google Drive API only in order to put content into AODocs.<span class="Apple-converted-space">Â  </span>There is little need to access the Drive API after this point, so you only need email scope.&lt;/p&gt;</p>
<p class="p1">&lt;/blockquote&gt;</p>
<p class="p1">&lt;h2&gt;Get an access and ID token&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;There are many ways of obtaining an OAuth 2.0 token.<span class="Apple-converted-space">Â  </span>Describing all the use cases is beyond the scope of this document.<span class="Apple-converted-space">Â  </span>You can read more about Google's approach on the following Google documentation pages:&lt;/p&gt;</p>
<p class="p1">&lt;ul&gt;</p>
<p class="p1">&lt;li&gt;&lt;a href="https://support.google.com/googleapi/answer/6158849?hl=en" target="_blank"&gt;Setting up OAuth 2.0 - API Console Help&lt;/a&gt;&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;&lt;a href="https://developers.google.com/identity/protocols/OAuth2" target="_blank"&gt;Using OAuth 2.0 to Access Google APIs | Google Identity Platform&lt;/a&gt;&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;&lt;a href="https://developers.google.com/identity/protocols/OAuth2UserAgent" target="_blank"&gt;OAuth 2.0 for Client-side Web Applications | Google Identity Platform&lt;/a&gt;&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;&lt;a href="https://developers.google.com/identity/protocols/OAuth2WebServer" target="_blank"&gt;Using OAuth 2.0 for Web Server Applications | Google Identity Platform&lt;/a&gt;&lt;/li&gt;</p>
<p class="p1">&lt;/ul&gt;</p>
<p class="p1">&lt;h2&gt;Use access or ID token&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;When you receive tokens from Google, they should look something along the lines of the following.&lt;/p&gt;</p>
<p class="p1">&lt;h3&gt;Sample tokens from Google&lt;/h3&gt;</p>
<p class="p1">&lt;pre class="hljs"&gt;&lt;code&gt;{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-attr"&gt;"access_token"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"ya29.Il-3B5J8...Fhl3a-yRjpg"&lt;/span&gt;,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-attr"&gt;"id_token"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"eyJhbGc8i...AaNVQ"&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-string"&gt;"expires_in"&lt;/span&gt;: &lt;span class="hljs-number"&gt;3600&lt;/span&gt;,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-attr"&gt;"token_type"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"Bearer"&lt;/span&gt;,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-attr"&gt;"scope"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"https://www.googleapis.com/auth/userinfo.email openid"&lt;/span&gt;,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;span class="hljs-attr"&gt;"refresh_token"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"1//04c6onWq2AZDqCgYIARAAGAQSNwF-L9Ir2sI1rrhHr4IsCX_yNfu1YM9yc8AqB-u04JncAQwIxM1mU9Qv1NGvzLSiixS768nWovE"&lt;/span&gt;</p>
<p class="p1">}</p>
<p class="p1">&lt;/code&gt;&lt;/pre&gt;</p>
<p class="p1">&lt;blockquote&gt;</p>
<p class="p1">&lt;p&gt;<span class="s1">â­‘</span> <span class="Apple-converted-space">Â  </span>&lt;strong&gt;Note&lt;/strong&gt;: Access tokens usually start with the string &lt;code&gt;ya29.&lt;/code&gt;, and because they're opaque (not actual data but pointers to data elsewhere), they're usually shorter than ID tokens.<span class="Apple-converted-space">Â  </span>The latter are longer because they contain actual data, encoded into three pieces: header, claims, and signature.&lt;/p&gt;</p>
<p class="p1">&lt;/blockquote&gt;</p>
<p class="p1">&lt;p&gt;Once you have obtained a token, you select which token is more appropriate for your use case:&lt;/p&gt;</p>
<p class="p1">&lt;ul&gt;</p>
<p class="p1">&lt;li&gt;access token for AODocs &lt;em&gt;and&lt;/em&gt; Drive&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;ID token for just AODocs&lt;/li&gt;</p>
<p class="p1">&lt;/ul&gt;</p>
<p class="p1">&lt;p&gt;You can access AODocs APIs by including one of the tokens as an &lt;code&gt;Authorization&lt;/code&gt; HTTP header &lt;code&gt;Bearer&lt;/code&gt; value:&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;&lt;code&gt;Authorization: Bearer &amp;lt; access_token | id_token &amp;gt;&lt;/code&gt;&lt;/p&gt;</p>
<p class="p1">&lt;h3&gt;Example request with token as header parameter&lt;/h3&gt;</p>
<p class="p1">&lt;pre class="hljs"&gt;&lt;code&gt;GET https://aodocs.altirnao.com/api/document/v1 HTTP/1.1</p>
<p class="p2"><br></p>
<p class="p1">Authorization: Bearer [YOUR_TOKEN] \</p>
<p class="p1">Accept: application/json \</p>
<p class="p1">Content-Type: application/json \</p>
<p class="p1">&lt;/code&gt;&lt;/pre&gt;</p>
<p class="p1">&lt;pre class="hljs"&gt;&lt;code&gt;{</p>
<p class="p1"><span class="Apple-converted-space">Â  </span>&lt;span class="hljs-attr"&gt;"libraryId"&lt;/span&gt;: &lt;span class="hljs-string"&gt;"Rngc1ug8K6WmL3IjZ8"&lt;/span&gt;</p>
<p class="p1">}</p>
<p class="p1">&lt;/code&gt;&lt;/pre&gt;</p>
<p class="p1">&lt;h3&gt;Example Java request with a token&lt;/h3&gt;</p>
<p class="p1">&lt;pre class="hljs"&gt;&lt;code&gt;<span class="Apple-converted-space">Â  </span>executeGet(&lt;span class="hljs-string"&gt;"https://aodocs.altirnao.com/api/document/v1/RnTzVT28x5Sb48h3vSQ"&lt;/span&gt;, myOAuthToken, otherParam1, requestBody)</p>
<p class="p1">&lt;/code&gt;&lt;/pre&gt;</p>
<p class="p1">&lt;h3&gt;Token expiration&lt;/h3&gt;</p>
<p class="p1">&lt;p&gt;Some tokens have a built-in expiration.<span class="Apple-converted-space">Â  </span>If you requested offline access to token scopes, you can &lt;a href="https://developers.google.com/identity/protocols/OAuth2InstalledApp#offline" target="_blank"&gt;refresh&lt;/a&gt; tokens as necessary without having to prompt the user for permission.&lt;/p&gt;</p>
<p class="p1">&lt;h2&gt;__Whitelisting users using Google Groups?&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;[TBD]&lt;/p&gt;</p>
<p class="p1">&lt;h2&gt;___Authentication errors with access/ID tokens&lt;/h2&gt;</p>
<p class="p1">&lt;p&gt;Token errors occur only when the token is:&lt;/p&gt;</p>
<p class="p1">&lt;ul&gt;</p>
<p class="p1">&lt;li&gt;missing?&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;incorrect?&lt;/li&gt;</p>
<p class="p1">&lt;li&gt;expired?&lt;/li&gt;</p>
<p class="p1">&lt;/ul&gt;</p>
<p class="p1">&lt;p&gt;To create,manage, and troubleshoot your tokens, seeâ€¦&lt;/p&gt;</p>
<p class="p1">&lt;h2&gt;Additional authentication and OAuth 2.0 resources&lt;/h2&gt;</p>
<p class="p1">&lt;h3&gt;___General readings&lt;/h3&gt;</p>
<p class="p1">&lt;p&gt;Read more about &lt;a href="https://developers.google.com/identity/protocols/OAuth2" target="_blank"&gt;using OAuth 2.0 to access APIs&lt;/a&gt; in Google's documentation.&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;More about &lt;a href="https://developers.google.com/drive/api/v3/about-auth" target="_blank"&gt;authenticating your users&lt;/a&gt; in general from Google.&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;&lt;a href="https://support.google.com/cloud/answer/9110914" target="_blank"&gt;Google Cloud scope FAQs&lt;/a&gt;&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;More about &lt;a href="https://oauth.net/2/" target="_blank"&gt;OAuth 2.0 in general&lt;/a&gt;.&lt;/p&gt;</p>
<p class="p1">&lt;p&gt;____other&lt;/p&gt;</p>
<p class="p1">&lt;/span&gt;&lt;/markdown-text&gt;</p>
</body>
</html>
